<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Chat con l'assistente</title>
    <link rel="stylesheet" href="/login_front/css/chat.css">
</head>
<body>
    <a href="/dashboard_utente" class="home-button">Dashboard</a>
    <div class="chat-container" style="max-width: 500px; margin: 2rem auto; padding: 1rem; background-color: #ffffff; border-radius: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.1);">
        <div class="chat-header" style="text-align: center; font-size: 1.5rem; font-weight: bold; margin-bottom: 1rem;">
            Chat con l'assistente medico
        </div>

        <div id="chat-box" class="chat-box" style="width: 100%; height: 400px; border-radius: 10px; border: 1px solid #ccc; overflow-y: auto; padding: 10px; background-color: #f9f9f9;"></div>

        <form id="chat-form" class="chat-form" style="margin-top: 1rem; display: flex; gap: 0.5rem;">
            <input type="hidden" name="client_id" value="{{ client_id }}">
            <input type="hidden" name="chat_number" value="{{ chat_number }}">
            <input type="text" id="msg" name="msg" placeholder="Scrivi un messaggio..." required class="chat-input" style="flex: 1;">
            <button type="submit" class="chat-button">Invia</button>
        </form>
    </div>

    <script id="chat-history-data" type="application/json">
        {{ history | tojson }}
    </script>

    <!--PROVA A LEGGERE MARKDOWN PER FORMATTAZIONE CARINA DEL TESTO-->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>


    <script>
    // JS AGGIORNATO CON POSIZIONE DI SESSIONE
    
    // preparo il form e gli elementi della pagina
    const form = document.getElementById("chat-form");
    const input = document.getElementById("msg");
    const chatBox = document.getElementById("chat-box");
    const historyDataTag = document.getElementById("chat-history-data");
    const chatHistory = JSON.parse(historyDataTag.textContent);

    // storico messaggi
    chatHistory.forEach(msg => {
        const bubble = document.createElement("div");
        bubble.textContent = msg.sender + ": " + msg.text;
        bubble.style.backgroundColor = msg.sender === "utente" ? "#d1e7dd" : "#f8d7da";
        bubble.style.margin = "5px 0";
        bubble.style.padding = "0.5rem";
        bubble.style.borderRadius = "5px";
        bubble.style.textAlign = msg.sender === "utente" ? "right" : "left";
        chatBox.appendChild(bubble);
    });

    chatBox.scrollTop = chatBox.scrollHeight;

    form.addEventListener("submit", (e) => {
        e.preventDefault();
        const userMsg = input.value;
        if (!userMsg.trim()) return;

        // disattivo input e bottone
        input.disabled = true;
        form.querySelector("button[type='submit']").disabled = true;

        // aggiunta bubble utente
        const userBubble = document.createElement("div");
        userBubble.textContent = userMsg;
        userBubble.style.backgroundColor = "#d1e7dd";
        userBubble.style.margin = "5px 0";
        userBubble.style.padding = "0.5rem";
        userBubble.style.borderRadius = "5px";
        userBubble.style.textAlign = "right";
        chatBox.appendChild(userBubble);
        chatBox.scrollTop = chatBox.scrollHeight;
        input.value = "";

        // funzione che invia il messaggio al backend
        const sendMessage = async (lat = null, lon = null) => {
            try {
                const res = await fetch("/chat/msg", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        client_id: document.querySelector('[name="client_id"]').value,
                        chat_number: document.querySelector('[name="chat_number"]').value,
                        new_msg: userMsg,
                        latitude: lat,
                        longitude: lon
                    })
                });

                const reply = await res.text();

                const aiBubble = document.createElement("div");
                
                // PROVANDO A LEGGERE MARKDOWN

                // aiBubble.textContent = reply;
                aiBubble.innerHTML = marked.parse(reply);


                aiBubble.style.backgroundColor = "#f8d7da";
                aiBubble.style.margin = "5px 0";
                aiBubble.style.padding = "0.5rem";
                aiBubble.style.borderRadius = "5px";
                aiBubble.style.textAlign = "left";
                chatBox.appendChild(aiBubble);
                chatBox.scrollTop = chatBox.scrollHeight;

            } catch (error) {
                console.error("Errore nella richiesta:", error);
            } finally {
                input.disabled = false;
                form.querySelector("button[type='submit']").disabled = false;
                input.focus();
            }
        };

        // provo a ottenere la posizione, altrimenti mando senza
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    sendMessage(lat, lon);
                },
                (error) => {
                    console.warn("Geolocalizzazione non disponibile:", error);
                    sendMessage(); // senza coordinate
                }
            );
        } else {
            console.warn("Geolocalizzazione non supportata dal browser.");
            sendMessage(); // senza coordinate
        }
    });
    </script>
</body>
</html>
